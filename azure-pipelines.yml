trigger: none

pool:
  vmImage: ubuntu-latest

variables:
- name: envName
  value: ${{ variables['Build.SourceBranchName'] }}

stages:
- stage: CI
  displayName: Build & Package Voice Agent
  jobs:
  - job: Build
    displayName: Prepare LiveKit Agent
    steps:

    # 1ï¸ Checkout source
    - checkout: self
      clean: true

    # 2 Inject env from Variable Group
    - script: |
        echo "LIVEKIT_API_KEY=$(LIVEKIT_API_KEY)" >> .env
        echo "LIVEKIT_API_SECRET=$(LIVEKIT_API_SECRET)" >> .env
        echo "LIVEKIT_URL=$(LIVEKIT_URL)" >> .env
      displayName: Create .env from Variable Group

    # 3 Validate required files (fail fast)
    - script: |
        test -f agent.py
        test -f requirements.txt
        test -f livekit.toml
      displayName: Validate project structure

    # 4 Publish artifact for CD
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: $(Build.SourcesDirectory)
        artifact: livekit-agent
        publishLocation: pipeline

- stage: CD
  displayName: Deploy to LiveKit Cloud
  dependsOn: CI
  condition: succeeded()

  jobs:

  # -------- DEV --------
  - deployment: DeployMain
    displayName: Deploy to Main
    environment: dev
    condition: eq(variables['Build.SourceBranchName'], 'main')

    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: livekit-agent
              path: $(Pipeline.Workspace)/agent
          
          # Install Livekit CLI
          - script: |
              curl -sSL https://get.livekit.io/cli | bash
              lk --help
            displayName: Install LiveKit CLI

          - script: |
              echo "===== livekit.toml used in CI ====="
              cat livekit.toml
              echo "=================================="
            displayName: DEBUG livekit.toml
  

          - script: |
              cd $(Pipeline.Workspace)/agent
              set -a
              source .env
              set +a

              echo "Using LiveKit URL: $LIVEKIT_URL"
  
              lk a deploy
            displayName: Deploy Agent

